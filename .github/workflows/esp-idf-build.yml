name: Production Release Build

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v0.1.0'

jobs:
  build-release:
    name: Build Production Firmware
    runs-on: ubuntu-latest
    container: espressif/idf:latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Cache ESP-IDF components
        uses: actions/cache@v4
        with:
          path: |
            firmware/build
            ~/.espressif
          key: ${{ runner.os }}-esp-idf-release-${{ hashFiles('firmware/sdkconfig*') }}
          restore-keys: |
            ${{ runner.os }}-esp-idf-release-

      - name: Build Production Firmware (Optimized)
        working-directory: firmware
        run: |
          . $IDF_PATH/export.sh
          # Build with optimizations
          idf.py -DCMAKE_BUILD_TYPE=Release build

      - name: Generate Changelog
        id: changelog
        run: |
          # Install git-cliff
          wget -q https://github.com/orhun/git-cliff/releases/download/v1.4.0/git-cliff-1.4.0-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf git-cliff-1.4.0-x86_64-unknown-linux-gnu.tar.gz
          chmod +x git-cliff-1.4.0/git-cliff
          
          # Generate changelog
          ./git-cliff-1.4.0/git-cliff --tag ${{ steps.version.outputs.VERSION }} --unreleased > CHANGELOG.md || {
            echo "No conventional commits found, creating basic changelog"
            echo "# Changelog for ${{ steps.version.outputs.VERSION }}" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 2>/dev/null || echo "")..HEAD >> CHANGELOG.md || echo "- Initial release" >> CHANGELOG.md
          }
          
          # Save changelog for later use
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate Build Info
        working-directory: firmware/build
        run: |
          echo "OpenFIDO-ESP Production Build" > BUILD_INFO.txt
          echo "Version: ${{ steps.version.outputs.VERSION }}" >> BUILD_INFO.txt
          echo "Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> BUILD_INFO.txt
          echo "Commit: ${{ github.sha }}" >> BUILD_INFO.txt
          echo "" >> BUILD_INFO.txt
          echo "=== Build Size ===" >> BUILD_INFO.txt
          . $IDF_PATH/export.sh
          idf.py size >> BUILD_INFO.txt
          echo "" >> BUILD_INFO.txt
          echo "=== Changelog ===" >> BUILD_INFO.txt
          cat ../CHANGELOG.md >> BUILD_INFO.txt 2>/dev/null || echo "No changelog available" >> BUILD_INFO.txt

      - name: Create Release Package
        working-directory: firmware/build
        run: |
          mkdir -p release-package
          cp *.bin release-package/ || true
          cp bootloader/bootloader.bin release-package/
          cp partition_table/partition-table.bin release-package/
          cp BUILD_INFO.txt release-package/
          cp ../README.md release-package/ || echo "No README in firmware dir"
          
          # Create flash script
          cat > release-package/flash.sh << 'EOF'
          #!/bin/bash
          echo "Flashing OpenFIDO-ESP Firmware..."
          esptool.py --chip esp32s3 --port /dev/ttyUSB0 --baud 460800 \
            --before default_reset --after hard_reset write_flash \
            -z --flash_mode dio --flash_freq 80m --flash_size detect \
            0x0 bootloader.bin \
            0x8000 partition-table.bin \
            0x10000 openfido-esp.bin
          EOF
          chmod +x release-package/flash.sh
          
          # Create Windows flash script
          cat > release-package/flash.bat << 'EOF'
          @echo off
          echo Flashing OpenFIDO-ESP Firmware...
          esptool.py --chip esp32s3 --port COM3 --baud 460800 ^
            --before default_reset --after hard_reset write_flash ^
            -z --flash_mode dio --flash_freq 80m --flash_size detect ^
            0x0 bootloader.bin ^
            0x8000 partition-table.bin ^
            0x10000 openfido-esp.bin
          pause
          EOF

      - name: Create Release Archive
        working-directory: firmware/build
        run: |
          tar -czf openfido-esp-${{ steps.version.outputs.VERSION }}.tar.gz release-package/
          zip -r openfido-esp-${{ steps.version.outputs.VERSION }}.zip release-package/

      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openfido-esp-release-${{ steps.version.outputs.VERSION }}
          path: |
            firmware/build/openfido-esp-${{ steps.version.outputs.VERSION }}.tar.gz
            firmware/build/openfido-esp-${{ steps.version.outputs.VERSION }}.zip
            firmware/build/release-package/
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            firmware/build/openfido-esp-${{ steps.version.outputs.VERSION }}.tar.gz
            firmware/build/openfido-esp-${{ steps.version.outputs.VERSION }}.zip
          body_path: firmware/build/release-package/BUILD_INFO.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Discord Notification (Success)
        if: success() && startsWith(github.ref, 'refs/tags/')
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          CHANGELOG: ${{ steps.changelog.outputs.CHANGELOG }}
          DOWNLOAD_URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }}
          COMMIT_SHA: ${{ github.sha }}
          NOTIFICATION_TYPE: release
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            pip install requests
            python .github/workflows/scripts/notify.py
          else
            echo "⚠️ DISCORD_WEBHOOK_URL not configured, skipping notification"
          fi

      - name: Display Build Logs on Failure
        if: failure()
        working-directory: firmware
        run: |
          echo "=== Production build failed. Displaying build log ==="
          cat build/build.log || echo "No build log found" > /tmp/error.log
          
      - name: Send Discord Notification (Failure)
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          ERROR_LOG: ${{ steps.build_error.outputs.ERROR_LOG }}
          NOTIFICATION_TYPE: failure
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            pip install requests
            export ERROR_LOG=$(cat /tmp/error.log 2>/dev/null || echo "No error log available")
            python .github/workflows/scripts/notify.py
          else
            echo "⚠️ DISCORD_WEBHOOK_URL not configured, skipping notification"
          fi
